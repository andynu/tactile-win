name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-action@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Build release
      run: cargo build --release

    - name: Create distribution folder
      run: |
        mkdir dist
        copy target\release\tactile-win.exe dist\
        copy README.md dist\
        copy disable-win-t.reg dist\
        copy enable-win-t.reg dist\

    - name: Create ZIP archive
      run: |
        Compress-Archive -Path dist\* -DestinationPath tactile-win-windows-x64.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: tactile-win-windows-x64
        path: tactile-win-windows-x64.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: tactile-win-windows-x64.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-installer:
    runs-on: windows-latest
    needs: build

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-action@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Build release
      run: cargo build --release

    - name: Install Inno Setup
      run: |
        choco install innosetup -y

    - name: Create installer
      run: |
        iscc installer.iss
      continue-on-error: true

    - name: Upload installer
      if: hashFiles('Output/tactile-win-setup.exe') != ''
      uses: actions/upload-artifact@v4
      with:
        name: tactile-win-installer
        path: Output/tactile-win-setup.exe

    - name: Add installer to release
      if: startsWith(github.ref, 'refs/tags/') && hashFiles('Output/tactile-win-setup.exe') != ''
      uses: softprops/action-gh-release@v1
      with:
        files: Output/tactile-win-setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
